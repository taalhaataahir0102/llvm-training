<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>3900689f549940f39981caf9787ae499</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<h1 id="pass-discription">Pass Discription</h1>
<p>Create CFg of a funtion. There ois a built in pass named view-cfg
which will create a dot file. We can use graphivz (sudo apt install
graphivz) to view this dot file in pdf:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install graphivz</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span>view-cfg dotexample.bc</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dot</span> <span class="at">-Tpdf</span> file.dot <span class="at">-o</span> file.pdf</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">We</span><span class="st">&#39;ll write our own implementation here.</span></span></code></pre></div>
<p>The dot file looks following:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>digraph <span class="st">&quot;CFG for &#39;main&#39; function&quot;</span> <span class="op">{</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    AAA <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">&quot;{BB0:\l\l  br BB1\l}&quot;</span><span class="op">];</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    AAA <span class="op">-&gt;</span> AAB<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    AAB <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        label<span class="op">=</span><span class="st">&quot;{BB1:\l\l</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>                <span class="op">%</span>i<span class="fl">.0</span> <span class="op">=</span> phi <span class="op">[</span> <span class="dv">1</span><span class="op">,</span> BB0 <span class="op">],</span> <span class="op">[</span> <span class="op">%</span><span class="dv">7</span><span class="op">,</span> BB10 <span class="op">]</span>\l</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>                <span class="op">%</span>max<span class="fl">.0</span> <span class="op">=</span> phi <span class="op">[</span> <span class="dv">0</span><span class="op">,</span> BB0 <span class="op">],</span> <span class="op">[</span> <span class="op">%</span>max<span class="fl">.1</span><span class="op">,</span> BB10 <span class="op">]</span>\l</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">%</span><span class="dv">2</span> <span class="op">=</span> icmp<span class="op">-</span>slt <span class="op">%</span>i<span class="fl">.0</span><span class="op">,</span> <span class="op">%</span>argc\l</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>                br <span class="op">%</span><span class="dv">2</span> BB3 BB11\l<span class="op">}</span><span class="st">&quot;];</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    AAB <span class="op">-&gt;</span> AAC<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    AAB <span class="op">-&gt;</span> AAD<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    AAC <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">&quot;{BB3:\l\l</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>                 <span class="op">%</span><span class="dv">4</span> <span class="op">=</span> getelementptr <span class="op">%</span>argv <span class="op">%</span>i<span class="fl">.0</span>\l</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                 <span class="op">%</span><span class="dv">5</span> <span class="op">=</span> load <span class="op">%</span><span class="dv">4</span>\l</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                 <span class="op">%</span><span class="dv">6</span> <span class="op">=</span> call atoi<span class="op">(%</span><span class="dv">5</span><span class="op">)</span>\l</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>                 <span class="op">%</span><span class="dv">7</span> <span class="op">=</span> add<span class="op">-</span>nsw <span class="op">%</span>i<span class="fl">.0</span><span class="op">,</span> <span class="dv">1</span>\l</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>                 <span class="op">%</span><span class="dv">8</span> <span class="op">=</span> icmp<span class="op">-</span>sgt <span class="op">%</span><span class="dv">6</span><span class="op">,</span> <span class="op">%</span>max<span class="fl">.0</span>\l</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>                 br <span class="op">%</span><span class="dv">8</span> BB9 BB10\l<span class="op">}</span><span class="st">&quot;];</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    AAC <span class="op">-&gt;</span> AAE<span class="op">;</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    AAC <span class="op">-&gt;</span> AAF<span class="op">;</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    AAE <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">&quot;{BB9:\l\l  br BB10\l}&quot;</span><span class="op">];</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    AAE <span class="op">-&gt;</span> AAF<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    AAF <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">&quot;{BB10:\l\l</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>         <span class="op">%</span>max<span class="fl">.1</span> <span class="op">=</span> phi <span class="op">[</span> <span class="op">%</span><span class="dv">6</span><span class="op">,</span> BB9 <span class="op">],</span> <span class="op">[</span> <span class="op">%</span>max<span class="fl">.0</span><span class="op">,</span> BB3 <span class="op">]</span>\l</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>         br BB1\l<span class="op">}</span><span class="st">&quot;];</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    AAF <span class="op">-&gt;</span> AAB<span class="op">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    AAD <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>         label<span class="op">=</span><span class="st">&quot;{BB11:\l\l</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>         <span class="op">%</span><span class="dv">12</span> <span class="op">=</span> call @printf<span class="op">(%</span>max<span class="fl">.0</span><span class="op">)</span>\l</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>         ret <span class="dv">0</span>\l<span class="op">}</span><span class="st">&quot;];</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<ol type="1">
<li>AAA, AAB etc. refers to basic blocks.</li>
<li>AAA -&gt; AAB means theres a connection from basic block AAA to
basic block AAB.</li>
<li>share=record make sure that the basic blocks are displayed inside a
square.</li>
<li>BB1, BB3 etc. will be the header of these basic blocks</li>
<li>lables have the instrcutions inside basic blocks.</li>
</ol>
<p>Link to the question:</p>
<p><a
href="https://homepages.dcc.ufmg.br/~fernando/classes/dcc888/assignment/">https://homepages.dcc.ufmg.br/~fernando/classes/dcc888/assignment/</a></p>
<h1 id="code">Code</h1>
<p>Here is the pass.cpp file:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/Pass.h&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/IR/Function.h&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/IR/BasicBlock.h&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/Transforms/Utils/NewDot.h&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/IR/InstIterator.h&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/IR/Instructions.h&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;llvm/IR/Value.h&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;map&gt;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fstream&gt;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sstream&gt;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>using namespace llvm<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>PreservedAnalyses NewDotPass<span class="op">::</span>run<span class="op">(</span>Module <span class="op">&amp;</span>M<span class="op">,</span> ModuleAnalysisManager <span class="op">&amp;</span>AM<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Creating a map to store the basic blocks and their successors</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>map<span class="op">&lt;</span>BasicBlock <span class="op">*,</span> std<span class="op">::</span>vector<span class="op">&lt;</span>BasicBlock <span class="op">*&gt;&gt;</span> BBSuccessors<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Creating a map to store basic block addresses and their instructions</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>map<span class="op">&lt;</span>BasicBlock <span class="op">*,</span> std<span class="op">::</span>vector<span class="op">&lt;</span>Instruction <span class="op">*&gt;&gt;</span> BBInstructions<span class="op">;</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Function <span class="op">&amp;</span>F <span class="op">:</span> M<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>F<span class="op">.</span>isDeclaration<span class="op">())</span> <span class="op">{</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        errs<span class="op">()</span> <span class="op">&lt;&lt;</span> F<span class="op">.</span>getName<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">&amp;</span>BB <span class="op">:</span> F<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Creating a vector to store the successors of the current basic block</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>            std<span class="op">::</span>vector<span class="op">&lt;</span>BasicBlock <span class="op">*&gt;</span> Successors<span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>Succ <span class="op">:</span> successors<span class="op">(&amp;</span>BB<span class="op">))</span> <span class="op">{</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Adding the successor to the vector</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                Successors<span class="op">.</span>push_back<span class="op">(</span>Succ<span class="op">);</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Storing the vector of successors in the map</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>            BBSuccessors<span class="op">[&amp;</span>BB<span class="op">]</span> <span class="op">=</span> Successors<span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Creating a vector to store instructions inside the basic block</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>            std<span class="op">::</span>vector<span class="op">&lt;</span>Instruction <span class="op">*&gt;</span> BBInstList<span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">&amp;</span>I <span class="op">:</span> BB<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Adding the instruction to the vector</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>                BBInstList<span class="op">.</span>push_back<span class="op">(&amp;</span>I<span class="op">);</span></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Storing the vector of instructions in the map</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>            BBInstructions<span class="op">[&amp;</span>BB<span class="op">]</span> <span class="op">=</span> BBInstList<span class="op">;</span></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Opening a new text file for writing</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    std<span class="op">::</span>ofstream outFile<span class="op">(</span><span class="st">&quot;new.dot&quot;</span><span class="op">);</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>outFile<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    errs<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;Error opening file for writing.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PreservedAnalyses<span class="op">::</span>all<span class="op">();</span> <span class="co">// Return if the file couldn&#39;t open</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Writing the DOT header</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;digraph G {</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterating over the map of basic block relationships and writing to the file</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">const</span> <span class="dt">auto</span> <span class="op">&amp;</span>entry <span class="op">:</span> BBSuccessors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>BB <span class="op">=</span> entry<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> std<span class="op">::</span>vector<span class="op">&lt;</span>BasicBlock <span class="op">*&gt;</span> <span class="op">&amp;</span>Successors <span class="op">=</span> entry<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>BasicBlock <span class="op">*</span>Succ <span class="op">:</span> Successors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>        outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;N&quot;</span> <span class="op">&lt;&lt;</span> BB <span class="op">&lt;&lt;</span> <span class="st">&quot; -&gt; &quot;</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;N&quot;</span> <span class="op">&lt;&lt;</span> Succ <span class="op">&lt;&lt;</span> <span class="st">&quot;;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Iterating over the map of basic block addresses and their instructions</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">const</span> <span class="dt">auto</span> <span class="op">&amp;</span>entry <span class="op">:</span> BBInstructions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    BasicBlock <span class="op">*</span>BBAddr <span class="op">=</span> entry<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> std<span class="op">::</span>vector<span class="op">&lt;</span>Instruction <span class="op">*&gt;</span> <span class="op">&amp;</span>Instructions <span class="op">=</span> entry<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;N&quot;</span> <span class="op">&lt;&lt;</span> BBAddr <span class="op">&lt;&lt;</span> <span class="st">&quot; [shape=record,label=</span><span class="sc">\&quot;</span><span class="st">{&quot;</span><span class="op">;</span></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Converting the basic block name to a C++ string</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    outFile <span class="op">&lt;&lt;</span> BBAddr<span class="op">-&gt;</span>getName<span class="op">().</span>str<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="st">&quot; :| &quot;</span><span class="op">;</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write the instructions</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>Instruction <span class="op">*</span>I <span class="op">:</span> Instructions<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>        std<span class="op">::</span>string InstText<span class="op">;</span></span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>        raw_string_ostream InstStream<span class="op">(</span>InstText<span class="op">);</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        I<span class="op">-&gt;</span>print<span class="op">(</span>InstStream<span class="op">);</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        outFile <span class="op">&lt;&lt;</span> InstStream<span class="op">.</span>str<span class="op">();</span></span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>        outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">l&quot;</span><span class="op">;</span> <span class="co">// Insert a newline after each instruction</span></span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Closing the record and label</span></span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;}</span><span class="sc">\&quot;</span><span class="st">];</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Writing the DOT footer</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>    outFile <span class="op">&lt;&lt;</span> <span class="st">&quot;}</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">;</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Closing the file</span></span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>    outFile<span class="op">.</span>close<span class="op">();</span></span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> PreservedAnalyses<span class="op">::</span>all<span class="op">();</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The comments inside the code are self-explainatory. We've used maps
here which are similar to python dictionary. One map is storing basic
blocks relationship and the other one is storing the basic blocks and
it's corresponding instrcutions. Instead of AAA,AAB etc. I'm storing the
address of the basic block. Finally after collcting all the data, I'm
making the dot file according to the required format.</p>
<h1 id="example-c-code">Example C code</h1>
<div class="sourceCode" id="cb4"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span>i <span class="op">&lt;</span> argc<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> aux <span class="op">=</span> atoi<span class="op">(</span>argv<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    i<span class="op">++;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>aux <span class="op">&gt;</span> max<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      max <span class="op">=</span> aux<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;Max = %d</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> max<span class="op">);</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h1 id="generating-ir">Generating IR</h1>
<div class="sourceCode" id="cb5"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">clang</span> <span class="at">-S</span> <span class="at">-O0</span> <span class="at">-Xclang</span> <span class="at">-disable-O0-optnone</span> <span class="at">-emit-llvm</span> <span class="at">-fno-discard-value-names</span> dotexample.c <span class="at">-o</span> dotexample.ll</span></code></pre></div>
<h1 id="output">Output</h1>
<p>Running pass on IR:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">./opt</span> <span class="at">-disable-output</span> <span class="at">-passes</span><span class="op">=</span>newdot dotexample.ll</span></code></pre></div>
<p>For the above example output dot file will look like this:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode C"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>digraph G <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>N0x55747d4aa330 <span class="op">-&gt;</span> N0x55747d4ab290<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab290 <span class="op">-&gt;</span> N0x55747d4ab530<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab290 <span class="op">-&gt;</span> N0x55747d4ab5b0<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab530 <span class="op">-&gt;</span> N0x55747d4ac150<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab530 <span class="op">-&gt;</span> N0x55747d4ac220<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>N0x55747d4ac150 <span class="op">-&gt;</span> N0x55747d4ac220<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>N0x55747d4ac220 <span class="op">-&gt;</span> N0x55747d4ab290<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>N0x55747d4aa330 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{entry :|   %retval = alloca i32, align 4\l  %argc.addr = alloca i32, align 4\l  %argv.addr = alloca ptr, align 8\l  %i = alloca i32, align 4\l  %max = alloca i32, align 4\l  %aux = alloca i32, align 4\l  store i32 0, ptr %retval, align 4\l  store i32 %argc, ptr %argc.addr, align 4\l  store ptr %argv, ptr %argv.addr, align 8\l  store i32 1, ptr %i, align 4\l  store i32 0, ptr %max, align 4\l  br label %while.cond\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab290 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{while.cond :|   %0 = load i32, ptr %i, align 4\l  %1 = load i32, ptr %argc.addr, align 4\l  %cmp = icmp slt i32 %0, %1\l  br i1 %cmp, label %while.body, label %while.end\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab530 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{while.body :|   %2 = load ptr, ptr %argv.addr, align 8\l  %3 = load i32, ptr %i, align 4\l  %idxprom = sext i32 %3 to i64\l  %arrayidx = getelementptr inbounds ptr, ptr %2, i64 %idxprom\l  %4 = load ptr, ptr %arrayidx, align 8\l  %call = call signext i32 @atoi(ptr noundef %4)\l  store i32 %call, ptr %aux, align 4\l  %5 = load i32, ptr %i, align 4\l  %inc = add nsw i32 %5, 1\l  store i32 %inc, ptr %i, align 4\l  %6 = load i32, ptr %aux, align 4\l  %7 = load i32, ptr %max, align 4\l  %cmp1 = icmp sgt i32 %6, %7\l  br i1 %cmp1, label %if.then, label %if.end\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>N0x55747d4ab5b0 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{while.end :|   %9 = load i32, ptr %max, align 4\l  %call2 = call signext i32 (ptr, ...) @printf(ptr noundef @.str, i32 noundef signext %9)\l  %10 = load i32, ptr %retval, align 4\l  ret i32 %10\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>N0x55747d4ac150 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{if.then :|   %8 = load i32, ptr %aux, align 4\l  store i32 %8, ptr %max, align 4\l  br label %if.end\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>N0x55747d4ac220 <span class="op">[</span>shape<span class="op">=</span>record<span class="op">,</span>label<span class="op">=</span><span class="st">&quot;{if.end :|   br label %while.cond, !llvm.loop !6\l}&quot;</span><span class="op">];</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Write following to view your cfg in pdf format:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">opt</span> <span class="at">-passes</span><span class="op">=</span>view-cfg dotexample.bc</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dot</span> <span class="at">-Tpdf</span> file.dot <span class="at">-o</span> file.pdf</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">open</span> file.pdf</span></code></pre></div>
</body>
</html>
